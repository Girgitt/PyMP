#!/usr/bin/env python
# coding=utf-8

import argparse
import configobj
import logging
import sys
import os
import socket

from multiprocessing.reduction import reduce_handle
from multiprocessing import active_children

sys.path.append('.')

from mysql_proto.engine import Engine

def main():
    # Setup arg handling
    parser = argparse.ArgumentParser(description='Python MySQL Proxy')
    # TODO: Set this to default to a sane path
    parser.add_argument('-c', '--config', default='conf/pymp.conf')

    args = parser.parse_args()

    # Initialize Config
    config = configobj.ConfigObj(os.path.abspath(args.config))
        
    # Start listening to port...
    serversocket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    serversocket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    serversocket.setsockopt(socket.IPPROTO_TCP, socket.TCP_NODELAY, 1)
    serversocket.bind((config['pymp']['ip'],
                       int(config['pymp']['port'])))
    serversocket.listen(int(
        config['pymp']['max_outstanding_connection_requests']))
    
    engines = []
    
    try:
        while True:
            (clientsocket, address) = serversocket.accept()
            engine = Engine(config, reduce_handle(clientsocket.fileno()))
            engine.daemon = True
            engine.start()
            engines.append(engine)
            engines = filter(lambda w: w in engines, active_children())
    except KeyboardInterrupt:
        pass
    finally:
        serversocket.close()

if __name__ == "__main__":
    main()
